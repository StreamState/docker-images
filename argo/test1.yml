{"apiVersion":"argoproj.io/v1alpha1","kind":"Workflow","metadata":{"generateName":"spark-streaming-ci-"},"spec":{"arguments":{"parameters":[{"name":"scalacode", "value":"cGFja2FnZSBzcGFya3dyYXBwZXJzCmltcG9ydCBvcmcuYXBhY2hlLnNwYXJrLnNxbC57RGF0YUZyYW1lLCBTcGFya1Nlc3Npb259CmltcG9ydCBvcmcuYXBhY2hlLnNwYXJrLnNxbC5zdHJlYW1pbmcuT3V0cHV0TW9kZQppbXBvcnQgb3JnLmFwYWNoZS5zcGFyay5zcWwudHlwZXMuewogIEludGVnZXJUeXBlLAogIFN0cmluZ1R5cGUsCiAgU3RydWN0RmllbGQsCiAgU3RydWN0VHlwZQp9Cm9iamVjdCBDdXN0b20gewogIHZhbCBzY2hlbWEgPSBTdHJ1Y3RUeXBlKAogICAgTGlzdCgKICAgICAgU3RydWN0RmllbGQoImlkIiwgSW50ZWdlclR5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgiZmlyc3RfbmFtZSIsIFN0cmluZ1R5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgibGFzdF9uYW1lIiwgU3RyaW5nVHlwZSwgdHJ1ZSksCiAgICAgIFN0cnVjdEZpZWxkKCJlbWFpbCIsIFN0cmluZ1R5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgiZ2VuZGVyIiwgU3RyaW5nVHlwZSwgdHJ1ZSksCiAgICAgIFN0cnVjdEZpZWxkKCJpcF9hZGRyZXNzIiwgU3RyaW5nVHlwZSwgdHJ1ZSkKICAgICkKICApCiAgZGVmIHByb2Nlc3MoZGZzOiBTZXFbRGF0YUZyYW1lXSk6IERhdGFGcmFtZSA9IHsKICAgIC8vZGYuc2VsZWN0RXhwcigiQ0FTVChrZXkgQVMgU1RSSU5HKSIsICJDQVNUKHZhbHVlIEFTIFNUUklORykgYXMgdmFsdWUiLCAiMSBhcyBncm91cFRlc3QiKS5ncm91cEJ5KCJncm91cFRlc3QiKS5jb3VudCgpCiAgICBkZnMoMCkuc2VsZWN0KCJmaXJzdF9uYW1lIiwgImxhc3RfbmFtZSIpCiAgfQogIGRlZiBzcWxQcm9jZXNzKAogICAgICBzcGFyazogU3BhcmtTZXNzaW9uLAogICAgICBkZjogRGF0YUZyYW1lLAogICAgICB0b3BpYzogU3RyaW5nCiAgKTogRGF0YUZyYW1lID0gewogICAgZGYuY3JlYXRlT3JSZXBsYWNlVGVtcFZpZXcodG9waWMpCiAgICBzcGFyay5zcWwoCiAgICAgIHMiU0VMRUNUIENBU1Qoa2V5IEFTIFNUUklORyksIENBU1QodmFsdWUgQVMgU1RSSU5HKSBhcyB2YWx1ZSwgMSBhcyBncm91cFRlc3QgZnJvbSAkdG9waWMgZ3JvdXAgYnkgZ3JvdXBUZXN0IgogICAgKQogIH0KICB2YWwgbW9kZSA9IE91dHB1dE1vZGUuQXBwZW5kKCkKfQo="}]},"entrypoint":"main","serviceAccountName":"argo-events-sa","templates":[{"dag":{"tasks":[{"arguments":{"parameters":[{"name":"scalacode","value":"{{inputs.parameters.scalacode}}"}]},"name":"A","template":"build-jar"},{"dependencies":["A"],"name":"B","template":"build-docker-image"}]},"inputs":{"parameters":[{"name":"scalacode"}]},"name":"main"},{"archiveLocation":{"archiveLogs":false},"container":{"args":["echo {{inputs.parameters.scalacode}} | base64 --decode \u003e src/main/scala/custom.scala;sbt assembly; cp streamstate.jar /work/streamstate.jar; ls -la /work;echo {{inputs.parameters.dockerfileline1}} \u003e /work/Final.Dockerfile;echo {{inputs.parameters.dockerfileline2}} \u003e\u003e /work/Final.Dockerfile;echo {{inputs.parameters.dockerfileline3}} \u003e\u003e /work/Final.Dockerfile;"],"command":["sh","-c"],"image":"gcr.io/streamstatetest/scalacompile:v0.5.0","volumeMounts":[{"mountPath":"/work","name":"work"}]},"inputs":{"parameters":[{"name":"scalacode"},{"name":"dockerfileline1","value":"FROM gcr.io/streamstatetest/sparkbase:v0.1.0"},{"name":"dockerfileline2","value":"COPY streamstate.jar /opt/spark/work-dir/streamstate.jar"},{"name":"dockerfileline3","value":"ENTRYPOINT [\"/opt/entrypoint.sh\"]"}]},"name":"build-jar"},{"container":{"args":["--dockerfile=/work/Final.Dockerfile","--context=dir:///work","--destination={{inputs.parameters.image}}"],"image":"gcr.io/kaniko-project/executor:latest","volumeMounts":[{"mountPath":"/work","name":"work"}],"workingDir":"/work"},"inputs":{"parameters":[{"name":"image","value":"us-central1-docker.pkg.dev/testorg/scalaapp:v0.1.0"}]},"name":"build-docker-image","serviceAccountName":"docker-cfg-write"}],"volumeClaimTemplates":[{"metadata":{"name":"work"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"64Mi"}}}}]}}