apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  #generateName: spark-streaming-ci-  # Name of this Workflow
  name: spark-streaming-ci
spec:
  serviceAccountName: argo-events-sa # TODO! create different service account than from line 7 and give minimum permissions
  entrypoint: main    
  #imagePullSecrets: 
  #- name: docker-cfg-read  
  volumeClaimTemplates:
  - metadata:
      name: work
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 64Mi
  templates:
  - name: main
    dag:
      tasks:
      - name: A
        template: build-jar
        arguments:
          parameters: 
            - name: scalacode
              value: cGFja2FnZSBzcGFya3dyYXBwZXJzCmltcG9ydCBvcmcuYXBhY2hlLnNwYXJrLnNxbC57RGF0YUZyYW1lLCBTcGFya1Nlc3Npb259CmltcG9ydCBvcmcuYXBhY2hlLnNwYXJrLnNxbC5zdHJlYW1pbmcuT3V0cHV0TW9kZQppbXBvcnQgb3JnLmFwYWNoZS5zcGFyay5zcWwudHlwZXMuewogIEludGVnZXJUeXBlLAogIFN0cmluZ1R5cGUsCiAgU3RydWN0RmllbGQsCiAgU3RydWN0VHlwZQp9Cm9iamVjdCBDdXN0b20gewogIHZhbCBzY2hlbWEgPSBTdHJ1Y3RUeXBlKAogICAgTGlzdCgKICAgICAgU3RydWN0RmllbGQoImlkIiwgSW50ZWdlclR5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgiZmlyc3RfbmFtZSIsIFN0cmluZ1R5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgibGFzdF9uYW1lIiwgU3RyaW5nVHlwZSwgdHJ1ZSksCiAgICAgIFN0cnVjdEZpZWxkKCJlbWFpbCIsIFN0cmluZ1R5cGUsIHRydWUpLAogICAgICBTdHJ1Y3RGaWVsZCgiZ2VuZGVyIiwgU3RyaW5nVHlwZSwgdHJ1ZSksCiAgICAgIFN0cnVjdEZpZWxkKCJpcF9hZGRyZXNzIiwgU3RyaW5nVHlwZSwgdHJ1ZSkKICAgICkKICApCiAgZGVmIHByb2Nlc3MoZGZzOiBTZXFbRGF0YUZyYW1lXSk6IERhdGFGcmFtZSA9IHsKICAgIC8vZGYuc2VsZWN0RXhwcigiQ0FTVChrZXkgQVMgU1RSSU5HKSIsICJDQVNUKHZhbHVlIEFTIFNUUklORykgYXMgdmFsdWUiLCAiMSBhcyBncm91cFRlc3QiKS5ncm91cEJ5KCJncm91cFRlc3QiKS5jb3VudCgpCiAgICBkZnMoMCkuc2VsZWN0KCJmaXJzdF9uYW1lIiwgImxhc3RfbmFtZSIpCiAgfQogIGRlZiBzcWxQcm9jZXNzKAogICAgICBzcGFyazogU3BhcmtTZXNzaW9uLAogICAgICBkZjogRGF0YUZyYW1lLAogICAgICB0b3BpYzogU3RyaW5nCiAgKTogRGF0YUZyYW1lID0gewogICAgZGYuY3JlYXRlT3JSZXBsYWNlVGVtcFZpZXcodG9waWMpCiAgICBzcGFyay5zcWwoCiAgICAgIHMiU0VMRUNUIENBU1Qoa2V5IEFTIFNUUklORyksIENBU1QodmFsdWUgQVMgU1RSSU5HKSBhcyB2YWx1ZSwgMSBhcyBncm91cFRlc3QgZnJvbSAkdG9waWMgZ3JvdXAgYnkgZ3JvdXBUZXN0IgogICAgKQogIH0KICB2YWwgbW9kZSA9IE91dHB1dE1vZGUuQXBwZW5kKCkKfQo=
      - name: B
        dependencies: [A]
        template: build-docker-image

  - name: build-jar     
    inputs:
      parameters:
        - name: scalacode
        - name: dockerfileline1 
          value: FROM gcr.io/streamstatetest/sparkbase:v0.1.0
        - name: dockerfileline2 
          value: COPY streamstate.jar /opt/spark/work-dir/streamstate.jar
        - name: dockerfileline3
          value: ENTRYPOINT ["/opt/entrypoint.sh"]
    container:
      volumeMounts:
      - mountPath: /work #this persists across steps
        name: work
      image: gcr.io/streamstatetest/scalacompile:v0.5.0
      command: [sh, -c]
      args: [
        "echo {{inputs.parameters.scalacode}} | base64 --decode > src/main/scala/custom.scala;\
        sbt assembly; cp streamstate.jar /work/streamstate.jar; ls -la /work;\
        echo {{inputs.parameters.dockerfileline1}} > /work/Final.Dockerfile;\
        echo {{inputs.parameters.dockerfileline2}} >> /work/Final.Dockerfile;\
        echo {{inputs.parameters.dockerfileline3}} >> /work/Final.Dockerfile;"
      ]
      #workingDir: /work
    archiveLocation: # maybe delete this...
      archiveLogs: false
     
  - name: build-docker-image
    inputs:
      parameters:
        # Name of the image to push
        - name: image
          # next step in debugging...try without testorg and see if that works
          # that didn't work...still doesnt have permission
          value: gcr.io/streamstatetest/scalaapp:v0.1.0 # TODO!  specify tag version
    serviceAccountName: docker-cfg-write # or does this need to be at the top level (ie, where argo-events-sa is)
    container:
      image: gcr.io/kaniko-project/executor:latest
      args:
      - "--dockerfile=/work/Final.Dockerfile"
      - "--context=dir:///work"
      - "--destination={{inputs.parameters.image}}"
      workingDir: /work
      volumeMounts:
      - mountPath: /work 
        name: work
      